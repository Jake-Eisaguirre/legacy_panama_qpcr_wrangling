---
title: "all_qpcr"
format: html
editor: source
---

## Load Packages

```{r}

if(!require(librarian)){
  install.packages(librarian)
  library(librarian)
}

shelf(tidyverse, here, DBI, RPostgres, janitor, readxl, parsedate, stringr)

```

## Read in clean tables

```{r}
#| messages: false
#| warning: false
files <- list.files(here("clean_qpcr"))

for (i in 1:n_distinct(files)) {
  
  a <- read_csv(here("clean_qpcr", files[i]))
  
  assign(str_remove(files[i], "_qpcr.csv"), a)
  
}
rm(a)


```

## Bind tables

```{r}

all_qpcr <- plyr::rbind.fill(panama, serdp, brazil, ucsb) %>% 
  select(!c(extraction_plate_id, qpcr_plate_id)) %>% 
  relocate(average_ct, .before = average_copy_number) %>% 
  relocate(c("total_volume_uL":"volume_template_dna_uL"), .after = average_copy_number) %>% 
  relocate(comments, .after = swab_type) %>% 
  rename(average_copy_number_per_swab = average_zoospores) %>% 
  mutate(average_copy_number_per_swab = if_else(is.na(average_copy_number_per_swab), 0, average_copy_number_per_swab),
         average_copy_number = if_else(is.na(average_copy_number), 0, average_copy_number),
         detected = if_else(average_copy_number > 0, 1, 0)) %>% 
  relocate(detected, .after = bd_swab_id) %>% 
  relocate(result, .before = replicate) %>% 
  relocate(average_ITS1_copies_per_swab, .after = average_copy_number_per_swab) %>% 
  relocate(its_multiplyer, .before = average_copy_number_per_swab) %>% 
  unite(dilution_factor, c("dilution_factor", "dillution_factor"), na.rm = T, sep = "") %>% 
  mutate(dilution_factor = if_else(dilution_factor == "", NA, dilution_factor)) %>% 
  rename(average_its1_copies_per_swab=average_ITS1_copies_per_swab) %>% 
  mutate(standard = if_else(standard == "pisces", "plasmid-pisces", standard))

write_csv(all_qpcr, here("final_qpcr", "merged_qpcr.csv"))

```


```{r}
#database connection
connection <- dbConnect(drv = dbDriver("Postgres"),
                        dbname = Sys.getenv("aws_dbname"),
                        host = Sys.getenv("aws_host"),
                        port = Sys.getenv("aws_port"),
                        user = Sys.getenv("aws_user"),
                        password = Sys.getenv("aws_password"))
#search path
dbExecute(connection, "set search_path to survey_data")

#query Data
bd_comp <- "select r.region, s.site, v.date, s2.detection_type, c.species_capture, c.bd_swab_id, bd.bd_swab_id
              from region r
              join site s on r.region_id = s.region_id
              join visit v on s.site_id = v.site_id
              join survey s2 on v.visit_id = s2.visit_id
              join capture c on s2.survey_id = c.survey_id
              join qpcr_bd_results bd on c.bd_swab_id = bd.bd_swab_id;"

bd_comp <- dbGetQuery(connection, bd_comp)

missing_ids <- anti_join(all_qpcr, bd_comp, by = c("bd_swab_id"))

c_cap <- "select c.bd_swab_id from capture c"
c_cap_id <- dbGetQuery(connection, c_cap)

```

